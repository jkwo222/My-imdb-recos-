name: nightly

on:
  schedule:
    - cron: "0 3 * * *"   # 3:00 UTC daily
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
      REGION: US
      ORIGINAL_LANGS: en
      SUBS_INCLUDE: netflix,prime_video,hulu,max,disney_plus,apple_tv_plus,peacock,paramount_plus
      MIN_MATCH_CUT: 58.0

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run engine
        run: |
          set -e
          python -m engine.runner

      # Build a compact debug bundle (zip) so you can share one file
      - name: Create debug bundle
        if: always()
        run: |
          set -e
          mkdir -p data/out/latest
          BUNDLE="data/out/latest/debug-data.zip"

          # Core outputs
          zip -j -9 "$BUNDLE" \
            data/out/latest/assistant_feed.json \
            data/out/latest/assistant_ranked.json \
            data/out/latest/summary.md \
            data/out/latest/run_meta.json \
            data/out/latest/debug_status.json 2>/dev/null || true

          # Personalization & pool state
          zip -9 "$BUNDLE" data/cache/state/persistent_pool.json 2>/dev/null || true
          zip -9 "$BUNDLE" data/cache/state/personal_state.json 2>/dev/null || true
          zip -9 "$BUNDLE" data/cache/state/personal_history.json 2>/dev/null || true

          # User inputs if present
          zip -9 "$BUNDLE" data/user/ratings.csv 2>/dev/null || true

          # Request caches (useful to verify sources)
          zip -r -9 "$BUNDLE" data/cache/tmdb 2>/dev/null || true
          zip -r -9 "$BUNDLE" data/cache/imdb 2>/dev/null || true

      - name: Upload debug bundle (single file)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-data
          path: data/out/latest/debug-data.zip
          if-no-files-found: warn
          compression-level: 6

      # Upload both outputs and key caches/state so we can diagnose runs
      - name: Upload artifacts (outputs + debug/state)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: out
          if-no-files-found: warn
          compression-level: 6
          path: |
            # Primary outputs
            data/out/latest
            # Personalization state (genre weights, profile snapshots, etc.)
            data/cache/state/personal_state.json
            data/cache/state/personal_history.json
            # Persistent item enrichment pool
            data/cache/state/persistent_pool.json
            # Feedback memory (downvotes / skips) if present
            data/cache/feedback
            # TMDB + IMDb request caches (for source verification / debugging)
            data/cache/tmdb
            data/cache/imdb

      - name: Add summary to run
        if: always()
        run: |
          echo "## Daily recommendations" >> "$GITHUB_STEP_SUMMARY"
          if [ -f data/out/latest/summary.md ]; then
            cat data/out/latest/summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "_No summary produced (data/out/latest/summary.md missing)._ " >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Ensure gh CLI
        if: always()
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            echo "gh CLI missing."; exit 0
          fi

      - name: Create/find 'Daily Recommendations' issue and comment results
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TITLE="Daily Recommendations"
          BODY="No summary produced for this run."
          if [ -f data/out/latest/summary.md ]; then
            BODY="$(cat data/out/latest/summary.md)"
          fi

          # find open issue by title
          ISSUE_NUMBER=$(gh api -X GET repos/${{ github.repository }}/issues --paginate -q \
            '.[] | select(.state=="open" and .title=="'"$TITLE"'") | .number' | head -n1)

          # create if missing
          if [ -z "$ISSUE_NUMBER" ]; then
            ISSUE_NUMBER=$(gh api -X POST repos/${{ github.repository }}/issues \
              -f title="$TITLE" -f body="Tracking thread for daily recommendation digests." -q '.number')
          fi

          # post comment
          gh api -X POST repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments \
            -f body="$BODY" >/dev/null

          echo "Commented to issue #$ISSUE_NUMBER"