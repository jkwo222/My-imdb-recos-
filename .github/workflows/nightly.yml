name: nightly

on:
  workflow_dispatch:
  schedule:
    - cron: "30 12 * * *" # daily 12:30 UTC; adjust as you like

permissions:
  contents: read
  issues: write

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      # === REQUIRED KEYS ===
      TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
      OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}

      # === YOUR IMDb (optional when CSV provided) ===
      IMDB_USER_ID: ${{ secrets.IMDB_USER_ID }}

      # === RATINGS CSV ===
      IMDB_RATINGS_CSV_PATH: data/ratings.csv

      # === CATALOG SWEEP SIZES ===
      TMDB_PAGES_MOVIE: 12
      TMDB_PAGES_TV: 12
      MAX_CATALOG: 6000
      INCLUDE_TV_SEASONS: "true"

      # === REGION + SUBSCRIPTIONS ===
      REGION: "US"
      SUBS_INCLUDE: "netflix,prime_video,hulu,max,disney_plus,apple_tv_plus,peacock,paramount_plus"

      # === BEHAVIOR ===
      SKIP_WINDOW_DAYS: "4"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (cached)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run engine
        run: python -m engine.runner

      - name: Format issue body
        id: render
        run: |
          python tools/render_issue.py > issue.md
          echo "today=$(date -u +%F)" >> $GITHUB_OUTPUT

      - name: Create Issue with results
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "Daily picks â€” ${{ steps.render.outputs.today }}"
          content-filepath: "issue.md"
          labels: recommendations