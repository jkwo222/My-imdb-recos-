name: nightly

on:
  schedule:
    - cron: "0 3 * * *"   # 3:00 UTC daily
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
      # If you created a "v4 API Read Access Token" (recommended), add it as a secret and uncomment below:
      TMDB_ACCESS_TOKEN: ${{ secrets.TMDB_ACCESS_TOKEN }}
      IMDB_USER_ID: ${{ secrets.IMDB_USER_ID }}
      REGION: US
      ORIGINAL_LANGS: en
      SUBS_INCLUDE: netflix,prime_video,hulu,max,disney_plus,apple_tv_plus,peacock,paramount_plus
      MIN_MATCH_CUT: 58
      DISCOVER_PAGES: 3

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run engine
        run: |
          set -e
          python -m engine.runner

      # Always try to pack debug data, even if engine failed, so we have something to inspect
      - name: Pack debug bundle (timestamped)
        if: always()
        run: |
          set -e
          python -m engine.debug_pack
          echo "Debug dir listing:"
          ls -lh data/debug || true

      # Keep only the latest 7 debug zips to prevent artifact bloat
      - name: Cleanup old debug zips (keep last 7)
        if: always()
        run: |
          set -e
          shopt -s nullglob
          mkdir -p data/debug
          files=(data/debug/debug-data-*.zip)
          # Sort by mtime desc, skip first 7, delete the rest
          ls -1t data/debug/debug-data-*.zip 2>/dev/null | tail -n +8 | xargs -r rm -f
          echo "After cleanup:"
          ls -lh data/debug || true

      # Upload the main output artifact only (keep lean)
      - name: Upload artifact — out (latest)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: out
          path: |
            data/out/latest
          if-no-files-found: warn
          compression-level: 6
          retention-days: 14

      # Upload the debug artifact separately (timestamped file name pattern)
      - name: Upload artifact — debug-data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-data
          path: data/debug/debug-data-*.zip
          if-no-files-found: warn
          # don't recompress the zip we just created
          compression-level: 0
          retention-days: 14

      - name: Add summary to run
        if: always()
        run: |
          echo "## Daily recommendations" >> "$GITHUB_STEP_SUMMARY"
          if [ -f data/out/latest/summary.md ]; then
            cat data/out/latest/summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "_No summary produced (data/out/latest/summary.md missing)._ " >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Ensure gh CLI
        if: always()
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            echo "gh CLI missing."; exit 0
          fi

      - name: Create/find 'Daily Recommendations' issue and comment results
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TITLE="Daily Recommendations"
          BODY="No summary produced for this run."
          if [ -f data/out/latest/summary.md ]; then
            BODY="$(cat data/out/latest/summary.md)"
          fi

          # find open issue by title
          ISSUE_NUMBER=$(gh api -X GET repos/${{ github.repository }}/issues --paginate -q \
            '.[] | select(.state=="open" and .title=="'"$TITLE"'") | .number' | head -n1)

          # create if missing
          if [ -z "$ISSUE_NUMBER" ]; then
            ISSUE_NUMBER=$(gh api -X POST repos/${{ github.repository }}/issues \
              -f title="$TITLE" -f body="Tracking thread for daily recommendation digests." -q '.number')
          fi

          # post comment
          gh api -X POST repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments \
            -f body="$BODY" >/dev/null

          echo "Commented to issue #$ISSUE_NUMBER"