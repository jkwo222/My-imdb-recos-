name: nightly

on:
  schedule:
    - cron: "0 3 * * *"   # 3:00 UTC daily
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
      REGION: US
      ORIGINAL_LANGS: en
      SUBS_INCLUDE: netflix,prime_video,hulu,max,disney_plus,apple_tv_plus,peacock,paramount_plus
      MIN_MATCH_CUT: 58.0
      DISCOVER_PAGES: 3
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Fetch IMDb TSVs (basics + ratings)
        run: |
          set -e
          mkdir -p data/cache/imdb
          cd data/cache/imdb
          echo "Downloading IMDb TSVs…"
          curl -fsSLO https://datasets.imdbws.com/title.basics.tsv.gz
          curl -fsSLO https://datasets.imdbws.com/title.ratings.tsv.gz
          echo "Unzipping…"
          gunzip -f title.basics.tsv.gz
          gunzip -f title.ratings.tsv.gz
          ls -lh

      - name: Run engine
        run: |
          set -e
          python -m engine.runner

      # Upload outputs + debug/state so we can analyze each run
      - name: Upload artifacts (outputs + debug/state)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: out
          if-no-files-found: warn
          compression-level: 6
          path: |
            # Primary outputs
            data/out/latest
            # Personalization state (if your imdb_sync writes these)
            data/cache/state/personal_state.json
            data/cache/state/personal_history.json
            # Persistent item enrichment pool
            data/cache/state/persistent_pool.json
            # Feedback memory (downvotes / skips) if present
            data/cache/feedback
            # TMDB + IMDb request caches (for source verification / debugging)
            data/cache/tmdb
            data/cache/imdb

      - name: Add summary to run
        if: always()
        run: |
          echo "## Daily recommendations" >> "$GITHUB_STEP_SUMMARY"
          if [ -f data/out/latest/summary.md ]; then
            cat data/out/latest/summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "_No summary produced (data/out/latest/summary.md missing)._ " >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Ensure gh CLI
        if: always()
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            echo "gh CLI missing."; exit 0
          fi

      - name: Create/find 'Daily Recommendations' issue and comment results
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TITLE="Daily Recommendations"
          BODY="No summary produced for this run."
          if [ -f data/out/latest/summary.md ]; then
            BODY="$(cat data/out/latest/summary.md)"
          fi

          ISSUE_NUMBER=$(gh api -X GET repos/${{ github.repository }}/issues --paginate -q \
            '.[] | select(.state=="open" and .title=="'"$TITLE"'") | .number' | head -n1)

          if [ -z "$ISSUE_NUMBER" ]; then
            ISSUE_NUMBER=$(gh api -X POST repos/${{ github.repository }}/issues \
              -f title="$TITLE" -f body="Tracking thread for daily recommendation digests." -q '.number')
          fi

          gh api -X POST repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments \
            -f body="$BODY" >/dev/null

          echo "Commented to issue #$ISSUE_NUMBER"